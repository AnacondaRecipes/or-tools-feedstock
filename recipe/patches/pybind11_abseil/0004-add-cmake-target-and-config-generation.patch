From fc4ae2807ca210119156c176c96f42b44788f8a1 Mon Sep 17 00:00:00 2001
From: Lorenzo Pirritano <lpirritano@anaconda.com>
Date: Fri, 10 Jan 2025 17:58:46 +0100
Subject: [PATCH 4/5] add-cmake-target-and-config-generation

---
 pybind11_abseil/CMakeLists.txt                | 39 ++++++++++++++-----
 .../pybind11_abseilConfig.cmake.in            | 21 ++++++++++
 2 files changed, 51 insertions(+), 9 deletions(-)
 create mode 100644 pybind11_abseil/pybind11_abseilConfig.cmake.in

diff --git a/pybind11_abseil/CMakeLists.txt b/pybind11_abseil/CMakeLists.txt
index ce7fd72..936e53a 100644
--- a/pybind11_abseil/CMakeLists.txt
+++ b/pybind11_abseil/CMakeLists.txt
@@ -199,20 +199,41 @@ if(BUILD_TESTING)
 endif()
 
 if(CMAKE_INSTALL_PYDIR)
-  # Copying to two target directories for simplicity. It is currently unknown
-  # how to determine here which copy is actually being used.
+  # Install all targets required for the project
   install(
     TARGETS status_py_extension_stub ok_status_singleton
+            status_pyinit_google3 ok_status_singleton_pyinit_google3
+            register_status_bindings ok_status_singleton_lib
+            absl_casters init_from_tag no_throw_status status_caster
+            status_not_ok_exception utils_pybind11_absl raw_ptr_from_capsule
+            check_status_module_imported status_from_py_exc void_ptr_from_capsule
+            py_base_utilities status_from_core_py_exc
+            import_status_module statusor_caster status_casters
     EXPORT pybind11_abseilTargets
     LIBRARY DESTINATION ${CMAKE_INSTALL_PYDIR}/pybind11_abseil
     ARCHIVE DESTINATION ${CMAKE_INSTALL_PYDIR}/pybind11_abseil
-    RUNTIME DESTINATION ${CMAKE_INSTALL_PYDIR}/pybind11_abseil)
+    RUNTIME DESTINATION ${CMAKE_INSTALL_PYDIR}/pybind11_abseil
+  )
 
+  # Generate and install the export file for these targets
   install(
-    TARGETS status_py_extension_stub ok_status_singleton
-    EXPORT pybind11_abseil_cppTargets
-    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
-    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
-    RUNTIME DESTINATION ${CMAKE_INSTALL_LIBDIR})
-
+    EXPORT pybind11_abseilTargets
+    FILE pybind11_abseilTargets.cmake
+    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/pybind11_abseil
+  )
+  message(STATUS "Destination for pybind11_abseilTargets.cmake at ${CMAKE_INSTALL_LIBDIR}/cmake/pybind11_abseil")
+
+  # Generate and install the package configuration file
+  include(CMakePackageConfigHelpers)
+  configure_package_config_file(
+    "${CMAKE_CURRENT_SOURCE_DIR}/pybind11_abseilConfig.cmake.in"
+    "${CMAKE_CURRENT_BINARY_DIR}/pybind11_abseilConfig.cmake"
+    INSTALL_DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/pybind11_abseil"
+  )
+  message(STATUS "Generated pybind11_abseilConfig.cmake at ${CMAKE_CURRENT_BINARY_DIR}/pybind11_abseilConfig.cmake")
+  install(
+    FILES "${CMAKE_CURRENT_BINARY_DIR}/pybind11_abseilConfig.cmake"
+    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/pybind11_abseil
+  )
+  message(STATUS "Destination for pybind11_abseilConfig.cmake at ${CMAKE_INSTALL_LIBDIR}/cmake/pybind11_abseil")
 endif()
diff --git a/pybind11_abseil/pybind11_abseilConfig.cmake.in b/pybind11_abseil/pybind11_abseilConfig.cmake.in
new file mode 100644
index 0000000..76a5a25
--- /dev/null
+++ b/pybind11_abseil/pybind11_abseilConfig.cmake.in
@@ -0,0 +1,21 @@
+@PACKAGE_INIT@
+
+include("${CMAKE_CURRENT_LIST_DIR}/pybind11_abseilTargets.cmake")
+
+# Ensure dependencies are available
+find_dependency(Python3 REQUIRED COMPONENTS Interpreter Development.Module)
+find_dependency(pybind11 REQUIRED)
+
+# Define the namespace
+set(PYBIND11_ABSEIL_NAMESPACE "pybind11_abseil::")
+
+# Recreate aliases for exported targets
+add_library(pybind11_abseil::status_casters ALIAS status_casters)
+add_library(pybind11_abseil::import_status_module ALIAS import_status_module)
+add_library(pybind11_abseil::status ALIAS status_py_extension_stub)
+add_library(pybind11_abseil::init_from_tag ALIAS init_from_tag)
+add_library(pybind11_abseil::statusor_caster ALIAS statusor_caster)
+add_library(pybind11_abseil::no_throw_status ALIAS no_throw_status)
+add_library(pybind11_abseil::ok_status_singleton ALIAS ok_status_singleton)
+add_library(pybind11_abseil::absl_casters ALIAS absl_casters)
+add_library(pybind11_abseil::status_caster ALIAS status_caster)
-- 
2.39.1

